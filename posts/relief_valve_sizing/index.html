<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Allan Farrell">
<meta name="dcterms.date" content="2024-10-28">
<meta name="description" content="Compressible orifice flow calculations using equations of state.">

<title>Relief Valve Sizing with Real Gases – A Chemical Engineer’s Notebook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-59228ce9c52eba116baca5d538563979.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #ffffff;
      }

      .quarto-title-block .quarto-title-banner {
        color: #ffffff;
background: url(../../images/pipes-unsplash-header.jpg);
      }
</style>
<style>
.quarto-title-block .quarto-title-banner {
  min-height: 100%;
  background-size: cover;
  box-shadow: inset 0 0 0 2000px rgba(0, 0, 0, 0.3);
}
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Relief Valve Sizing with Real Gases – A Chemical Engineer’s Notebook">
<meta property="og:description" content="Compressible orifice flow calculations using equations of state.">
<meta property="og:image" content="https://aefarrell.github.io/posts/relief_valve_sizing/pressure_relief.png">
<meta property="og:site_name" content="A Chemical Engineer's Notebook">
<meta property="og:image:height" content="777">
<meta property="og:image:width" content="1483">
</head>

<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">A Chemical Engineer’s Notebook</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> <i class="bi bi-info-circle" role="img">
</i> 
<span class="menu-text">about</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> <i class="bi bi-wrench-adjustable-circle" role="img">
</i> 
<span class="menu-text">projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> <i class="bi bi-archive" role="img">
</i> 
<span class="menu-text">posts</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/aefarrell/aefarrell.github.io/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Relief Valve Sizing with Real Gases</h1>
                  <div>
        <div class="description">
          Compressible orifice flow calculations using equations of state.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">julia</div>
                <div class="quarto-category">pressure relief</div>
                <div class="quarto-category">compressible flow</div>
                <div class="quarto-category">equations of state</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Allan Farrell </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 28, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#sizing-a-pressure-relief-valve" id="toc-sizing-a-pressure-relief-valve" class="nav-link active" data-scroll-target="#sizing-a-pressure-relief-valve">Sizing a Pressure Relief Valve</a>
  <ul class="collapse">
  <li><a href="#choked-flow" id="toc-choked-flow" class="nav-link" data-scroll-target="#choked-flow">Choked Flow</a></li>
  </ul></li>
  <li><a href="#a-motivating-example" id="toc-a-motivating-example" class="nav-link" data-scroll-target="#a-motivating-example">A Motivating Example</a></li>
  <li><a href="#the-ideal-gas-case" id="toc-the-ideal-gas-case" class="nav-link" data-scroll-target="#the-ideal-gas-case">The Ideal Gas Case</a></li>
  <li><a href="#the-isentropic-expansion-factor" id="toc-the-isentropic-expansion-factor" class="nav-link" data-scroll-target="#the-isentropic-expansion-factor">The Isentropic Expansion Factor</a></li>
  <li><a href="#solving-the-choked-flow-energy-balance" id="toc-solving-the-choked-flow-energy-balance" class="nav-link" data-scroll-target="#solving-the-choked-flow-energy-balance">Solving the Choked Flow Energy Balance</a></li>
  <li><a href="#direct-integration" id="toc-direct-integration" class="nav-link" data-scroll-target="#direct-integration">Direct Integration</a></li>
  <li><a href="#comparing-the-results" id="toc-comparing-the-results" class="nav-link" data-scroll-target="#comparing-the-results">Comparing the Results</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p>Very often, in chemical engineering, the line between problems one can solve one’s self and problems that are solved with a piece of commercial software is when ideal fluid assumptions break down. Relief valve sizing is a typical example: if the fluid is (approximately) an ideal gas then sizing is simple and often done in a spreadsheet. When this isn’t the case, if the compressiblity is &lt;0.8 or &gt;1.1,<span class="citation" data-cites="API-2020"><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></span> then one typically has to turn to some commercial software. Models of real fluids are complicated and extracting the relevant thermodynamic properties from them can be quite tedious when doing it all from scratch.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;<a href="#ref-API-2020" role="doc-biblioref">API, <em>Standard 520, Sizing, Selection, and Installation of Pressure-Relieving Devices, Part i - Sizing and Selection, 10th Ed</em>, 68</a>.</p></div></div><p><a href="https://clapeyronthermo.github.io/Clapeyron.jl/stable/">Clapeyron.jl</a> comes to the rescue here with a wide array of equations of state for real fluids. Combined with julia’s robust ecosystem of libraries for integration and optimization, solving real fluid problems becomes simple. This post walks through how to size a relief device, in gas service, starting from an ideal gas and working through various methods for real gases using equations of state.</p>
<section id="sizing-a-pressure-relief-valve" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="sizing-a-pressure-relief-valve">Sizing a Pressure Relief Valve</h2>
<p>The general idea for sizing a relief valve is to determine the minimum area required such that the mass flow through the valve equals the mass flow required for the governing release case via the relation<span class="citation" data-cites="API-2020"><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;<a href="#ref-API-2020" role="doc-biblioref">API, <em>Standard 520, Sizing, Selection, and Installation of Pressure-Relieving Devices, Part i - Sizing and Selection, 10th Ed</em></a> equation B.5.</p></div></div><p><span class="math display">\[ W = K A G \]</span></p>
<p>where <span class="math inline">\(W\)</span> is the required mass flow-rate, <span class="math inline">\(K\)</span> is a capacity correction, <span class="math inline">\(A\)</span> is the theoretical flow area, and <span class="math inline">\(G\)</span> the frictionless) mass flux through the valve. Valves are sized based on the theoretical flow area.</p>
<p>The general process is as follows:</p>
<ol type="1">
<li>Determine the governing release rate, <span class="math inline">\(W\)</span></li>
<li>Determine the capacity correction, <span class="math inline">\(K\)</span></li>
<li>Calculate the mass flux through the valve, <span class="math inline">\(G\)</span></li>
<li>Calculate the theoretical flow area <span class="math inline">\(A = \frac{W}{K G}\)</span></li>
<li>Select the appropriate valve with a flow area <span class="math inline">\(&gt;A\)</span>.</li>
</ol>
<p>Standards, such as API-2020, give equations that combine steps 3 and 4 and absorb unit-conversions into the constants, so that the equation is in a more convenient form, but this is what is happening under the hood.</p>
<p>The complications creep in through calculating <span class="math inline">\(G\)</span>, it is path-dependent and is a function of the equation of state for the fluid. For gas releases the relief device is typically treated as an isentropic nozzle, the assumption being that the flow-rate through the valve is typically large enough that any heat transfer can be neglected.</p>
<div id="fig-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pressure_relief.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: A hypothetical pressure relief device, connected to a pressure reservoir (1) and discharging into the atmosphere (2).
</figcaption>
</figure>
</div>
<p>Consider the differential form of the <a href="https://en.wikipedia.org/wiki/Bernoulli%27s_principle">mechanical energy balance</a>, along a streamline from the stagnation point, in the vessel, through the valve and out into the atmosphere, assuming no elevation change and no friction</p>
<p><span class="math display">\[ dP + \rho u du = 0 \]</span></p>
<p><span class="math display">\[ u du = -\frac{dP}{\rho} = - vdP \]</span></p>
<p>Integrating from the stagnation point to the throat of the nozzle gives</p>
<p><span class="math display">\[ \frac{1}{2} u_t^2 = - \int_{P_1}^{P_t} v dP \]</span></p>
<p>Where the velocity at the stagnation point, <span class="math inline">\(u_1=0\)</span>. Putting this in terms of the mass flux <span class="math inline">\(u = v G\)</span></p>
<p><span class="math display">\[ \frac{1}{2} v_t^2 G_t^2 = - \int_{P_1}^{P_t} v dP \]</span></p>
<p><span class="math display">\[ G_t = \frac{1}{v_t} \sqrt{-2 \int_{P_1}^{P_t} v dP} = \rho_t \sqrt{2 \int_{P_t}^{P_1} v dP} \]</span></p>
<p>This integral cannot be solved directly at this point as the conditions at the throat of the nozzle are not known. Solving this requires simultaneously solving for the nozzle conditions, <span class="math inline">\(P_t, T_t\)</span>.</p>
<p>If we specify that the streamline follows an isentropic path, then we can construct a constrained maximization problem: the nozzle conditions are the <span class="math inline">\(P_t\)</span> and <span class="math inline">\(T_t\)</span> which maximizes <span class="math inline">\(G_t\)</span> where the integration is taken along an isentropic path.</p>
<section id="choked-flow" class="level3">
<h3 class="anchored" data-anchor-id="choked-flow">Choked Flow</h3>
<p>In the case where flow is choked, i.e.&nbsp;the flow in the nozzle reaches sonic velocity, the maximum <span class="math inline">\(G_t\)</span> occurs at the sonic velocity with a pressure <span class="math inline">\(P_t &gt; P_2\)</span>. This can allow for the direct calculation of the mass flux as <span class="math inline">\(G_t = \rho_t c_t\)</span>, where <span class="math inline">\(c_t\)</span> is the sonic velocity at the throat. No integration required.</p>
</section>
</section>
<section id="a-motivating-example" class="level2">
<h2 class="anchored" data-anchor-id="a-motivating-example">A Motivating Example</h2>
<p>Consider the release of ethane from a vessel at 200 bar and 400 K, for the sake of simplicity assume the release is directly into the atmosphere at 1 bar and 288.15 K (15°C) (the flow is going to be choked, so this doesn’t actually matter).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Unitful</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the vessel properties</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    P₁ <span class="op">=</span> <span class="fl">200</span>u<span class="st">"bar"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    T₁ <span class="op">=</span> <span class="fl">400</span>u<span class="st">"K"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the ambient properties</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    P₂ <span class="op">=</span> <span class="fl">1</span>u<span class="st">"bar"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    T₂ <span class="op">=</span> <span class="fl">288.15</span>u<span class="st">"K"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can use <code>Clapeyron.jl</code> to initialize a few example equations of state for ethane. In this case I’m going to use an ideal gas model (<code>ReidIdeal</code> is an ideal gas model that also includes correlations for the ideal gas heat capacity), a cubic equation of state (volume translated Peng Robinson), and an empirical Helmholtz model (GERG-2008).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Clapeyron</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># assorted equations of state for ethane</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    ig_ethane <span class="op">=</span> <span class="fu">ReidIdeal</span>([<span class="st">"ethane"</span>])</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    vtpr_ethane <span class="op">=</span> <span class="fu">VTPR</span>([<span class="st">"ethane"</span>]; idealmodel <span class="op">=</span> ReidIdeal)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    gerg_ethane <span class="op">=</span> <span class="fu">GERG2008</span>([<span class="st">"ethane"</span>])</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is a hack, ideal models in Clapeyron do not return a </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># molar weight and so cannot return a mass density</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Clapeyron.<span class="fu">mw</span>(model<span class="op">::</span><span class="dt">IdealModel</span>) <span class="op">=</span> Clapeyron.<span class="fu">mw</span>(vtpr_ethane)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>At system conditions ethane is a super critical fluid, with the temperature and pressure above the critical point, which can be modelled as a dense gas.</p>
</section>
<section id="the-ideal-gas-case" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-ideal-gas-case">The Ideal Gas Case</h2>
<p>Considering the choked flow case, we know that <span class="math inline">\(G_t = \frac{c_t}{v_t}\)</span> and, for an ideal gas, the sonic velocity is given by<span class="citation" data-cites="tilton-2008"><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;<a href="#ref-tilton-2008" role="doc-biblioref">Tilton, <span>“Fluid and Particle Dynamics”</span></a> equation 6-113.</p></div></div><p><span class="math display">\[ c = \sqrt{ {k R T} \over M} = \sqrt{k P v} \]</span></p>
<p>Combining these we have</p>
<p><span class="math display">\[ G_t = \frac{c_t}{v_t} = { \sqrt{ k P_t v_t } \over v_t } = \sqrt{ k P_t \over v_t } \]</span></p>
<p>It can be shown that, along an isentropic path defined by <span class="math inline">\(P v^k = \mathrm{const}\)</span>, the critical pressure ratio is<span class="citation" data-cites="tilton-2008"><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;<a href="#ref-tilton-2008" role="doc-biblioref">Tilton</a> equation 6-119.</p></div></div><p><span class="math display">\[ {P_t \over P_1} = { P_{chk} \over P_1 } = \left(2 \over {k+1} \right)^{k \over {k-1} } \]</span></p>
<p>Which allows us to write</p>
<p><span class="math display">\[ P_t = P_1 {P_t \over P_1} = P_1 \left(2 \over {k+1} \right)^{k \over {k-1} } \]</span></p>
<p>and (using <span class="math inline">\(P_1 v_1^k = P_t v_t^k\)</span>)</p>
<p><span class="math display">\[ v_t = v_1 \left(P_1 \over P_t \right)^{1 \over k} = v_1 \left(2 \over {k+1} \right)^{-1 \over {k-1} } \]</span></p>
<p>Substituting back into the equation for <span class="math inline">\(G_t\)</span><span class="citation" data-cites="API-2020"><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;<a href="#ref-API-2020" role="doc-biblioref">API, <em>Standard 520, Sizing, Selection, and Installation of Pressure-Relieving Devices, Part i - Sizing and Selection, 10th Ed</em></a> equation B.21.</p></div></div><p><span class="math display">\[ G_t = \sqrt{ k \frac{P_1}{v_1} \left(2 \over {k+1} \right)^{k+1 \over {k-1} } } \]</span></p>
<p>or, to put it in terms of density</p>
<p><span class="math display">\[ G_t = \sqrt{ k P_1 \rho_1 \left(2 \over {k+1} \right)^{k+1 \over {k-1} } } \]</span></p>
<p>where <span class="math inline">\(k\)</span>, the isentropic expansion factor for an ideal gas, is the ratio of heat capacities</p>
<p><span class="math display">\[ k = { c_{p,ig} \over c_{v,ig} } \]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is the basis of API 520 Part 1 equation 9 where the following substitutions is made:</p>
<p><span class="math display">\[ \rho = { {P M} \over {Z R T} } \]</span></p>
<p>and the constant <span class="math inline">\(R\)</span> and some unit conversions are rolled up into the constant 0.03948 in the expression for <span class="math inline">\(C\)</span></p>
<p><span class="math display">\[ R = 8.314 { {\mathrm{m^3} \cdot \mathrm{Pa} } \over {\mathrm{mol} \cdot \mathrm{K} } } = 8,314 { {\mathrm{m^3} \cdot \mathrm{Pa} } \over {\mathrm{kmol} \cdot \mathrm{K} } } = 8,314 { {\mathrm{kg} \cdot \mathrm{m^2} } \over { \mathrm{kmol} \cdot \mathrm{s^2} \cdot \mathrm{K} } } \]</span></p>
<p><span class="math display">\[ {1 \over \sqrt{8,314} } \left[ { \sqrt{ \mathrm{kmol} \cdot \mathrm{K} } \cdot \mathrm{s} } \over { \sqrt{\mathrm{kg} } \cdot \mathrm{m} } \right] \times 3600 \left[ \mathrm{s} \over \mathrm{h} \right] \times 10^{-6} \left[ \mathrm{m^2} \over \mathrm{mm^2} \right] \times 10^3 \left[ \mathrm{Pa} \over \mathrm{kPa} \right] \]</span></p>
<p><span class="math display">\[ = 0.03948 \left[ \sqrt{\mathrm{kmol} \cdot \mathrm{kg} \cdot \mathrm{K} } \over { \mathrm{h} \cdot \mathrm{mm^2} \cdot \mathrm{kPa} } \right] \]</span></p>
</div>
</div>
<p>We can use <code>Clapeyron.jl</code> to calculate <span class="math inline">\(k\)</span> at any given temperature, using correlations for the ideal gas heat capacity.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">isentropic_expansion_factor</span>(model<span class="op">::</span><span class="dt">IdealModel</span>, P, T; z<span class="op">=</span>[<span class="fl">1.0</span>])</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    cₚ_ig <span class="op">=</span> <span class="fu">isobaric_heat_capacity</span>(model, P, T; phase<span class="op">=:</span>vapor)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    cᵥ_ig <span class="op">=</span> <span class="fu">isochoric_heat_capacity</span>(model, P, T; phase<span class="op">=:</span>vapor)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cₚ_ig<span class="op">/</span>cᵥ_ig</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>From which we calculate k= 1.146.</p>
<p>We can check our work by comparing with the tabulated values. At 15°C and 1 atm we calculate k= 1.193 which is the same as the tabulated value of 1.19 (given at 15°C and 1 atm).<span class="citation" data-cites="API-2020"><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;<a href="#ref-API-2020" role="doc-biblioref">API, 70</a>.</p></div></div><div class="sourceCode" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mass_flux_choked</span>(model, P, T; z<span class="op">=</span>[<span class="fl">1.0</span>])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="fu">isentropic_expansion_factor</span>(model, P, T; z<span class="op">=</span>z)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    ρ <span class="op">=</span> <span class="fu">mass_density</span>(model, P, T, z; phase<span class="op">=:</span>vapor)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    Gₜ² <span class="op">=</span> <span class="fu">k*P*ρ*</span>(<span class="fl">2</span><span class="op">/</span>(k<span class="op">+</span><span class="fl">1</span>))<span class="op">^</span>((k<span class="op">+</span><span class="fl">1</span>)<span class="op">/</span>(k<span class="op">-</span><span class="fl">1</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">√</span>(Gₜ²)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The theoretical mass flux for the ideal gas is then 38359 kg m^-2 s^-1</p>
<p>The ideal gas model, when the flow is choked, calculates the mass flux directly without needing to calculate the actual conditions at the nozzle. These can be calculated easily as well.<span class="citation" data-cites="tilton-2008"><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;<a href="#ref-tilton-2008" role="doc-biblioref">Tilton, <span>“Fluid and Particle Dynamics”</span></a> equations 6-119 and 6-120.</p></div></div><div class="sourceCode" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nozzle_pressure_ideal</span>(P, T, k) <span class="op">=</span> <span class="fu">P*</span>(<span class="fl">2</span><span class="op">/</span>(k<span class="op">+</span><span class="fl">1</span>))<span class="op">^</span>(k<span class="op">/</span>(k<span class="op">-</span><span class="fl">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nozzle_temperature_ideal</span>(P, T, k) <span class="op">=</span> <span class="fu">T*</span>(<span class="fl">2</span><span class="op">/</span>(k<span class="op">+</span><span class="fl">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The pressure at the nozzle is 115 bar the temperature at the nozzle is 373 K, which is above the critical point. The fluid supercritical and choked when leaving the PSV.</p>
</section>
<section id="the-isentropic-expansion-factor" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-isentropic-expansion-factor">The Isentropic Expansion Factor</h2>
<p>At the vessel conditions, the VTPR model of ethane gives a compressibility factor of 0.672 (GERG-2008 model gives a similar value of 0.69), well below 0.8 and therefore outside the range where the ideal gas model is expected to work well.</p>
<p>An alternative method is to calculate what the <em>effective</em> isentropic expansion factor would be, for the real gas, assuming that the real fluid obeys</p>
<p><span class="math display">\[ P_1 v_1^n = P_t v_t^n \]</span></p>
<p>where <span class="math inline">\(n\)</span> is a constant.</p>
<p>The derivation of <span class="math inline">\(n\)</span> follows from the definition of the speed of sound in a gas<span class="citation" data-cites="tilton-2008 gmehling-2012"><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;<a href="#ref-tilton-2008" role="doc-biblioref">Tilton, 6–22</a>; <a href="#ref-gmehling-2012" role="doc-biblioref">Gmehling et al., <em>Chemical Thermodynamics for Process Simulation</em>, 113</a>.</p></div></div><p><span class="math display">\[ c = \sqrt{ \left( {\partial P} \over {\partial \rho} \right)_S} =\sqrt{ -v^2 \left( {\partial P} \over {\partial v} \right)_S} \]</span></p>
<p>The constant entropy partial derivative can be re-written to eliminate entropy<span class="citation" data-cites="gmehling-2012"><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;<a href="#ref-gmehling-2012" role="doc-biblioref">Gmehling et al., <em>Chemical Thermodynamics for Process Simulation</em>, 660</a>.</p></div></div><p><span class="math display">\[ \left( {\partial P} \over {\partial v} \right)_S = { { \left( {\partial S} \over {\partial T} \right)_P \left( {\partial P} \over {\partial T} \right)_v } \over { \left( {\partial S} \over {\partial T} \right)_v \left( {\partial v} \over {\partial T} \right)_P } } \]</span></p>
<p>Using the relations<span class="citation" data-cites="gmehling-2012"><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn10"><p><sup>10</sup>&nbsp;<a href="#ref-gmehling-2012" role="doc-biblioref">Gmehling et al., <em>Chemical Thermodynamics for Process Simulation</em></a> equations C.21 and C.8 (respectively).</p></div></div><p><span class="math display">\[ c_p = T \left( {\partial S} \over {\partial T} \right)_P \]</span></p>
<p>and</p>
<p><span class="math display">\[ c_v =  T \left( {\partial S} \over {\partial T} \right)_V \]</span></p>
<p>we get</p>
<p><span class="math display">\[ \left( {\partial P} \over {\partial v} \right)_S = {c_p \over c_v} \left( {\partial P} \over {\partial v} \right)_T \]</span></p>
<p>and the sonic velocity is then</p>
<p><span class="math display">\[ c = \sqrt{ -v^2 {c_p \over c_v} \left( {\partial P} \over {\partial v} \right)_T } \]</span></p>
<p>equating this to the ideal gas case, <span class="math inline">\(c = \sqrt{n P v}\)</span>, and solving for <span class="math inline">\(n\)</span> gives<span class="citation" data-cites="API-2020"><a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a></span></p>
<div class="no-row-height column-margin column-container"><div id="fn11"><p><sup>11</sup>&nbsp;<a href="#ref-API-2020" role="doc-biblioref">API, <em>Standard 520, Sizing, Selection, and Installation of Pressure-Relieving Devices, Part i - Sizing and Selection, 10th Ed</em></a> equation B.13.</p></div></div><p><span class="math display">\[ n = -\frac{v}{P} {c_p \over c_v} \left( {\partial P} \over {\partial v} \right)_T \]</span></p>
<p>where <span class="math inline">\(n\)</span> has been used to distinguish it from <span class="math inline">\(k\)</span> (the ideal gas case). This is the version of <span class="math inline">\(n\)</span> presented in most references, such as API 520. The derivation, however, hints at a useful shortcut to calculating <span class="math inline">\(n\)</span> that does not require digging into the internals of <code>Clapeyron.jl</code> to retrieve partial derivatives:</p>
<p><span class="math display">\[ n = { c^2 \over {P v} } = { {\rho c^2} \over P } \]</span></p>
<p>The remainder of the calculations are identical as the ideal gas case, simply substituting <span class="math inline">\(n\)</span> wherever <span class="math inline">\(k\)</span> appears. Unfortunately <span class="math inline">\(n\)</span> is not actually constant and depends on the temperature and pressure, which are not actually known in the nozzle, so the temperature and pressure at the stagnation point are often used instead.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">isentropic_expansion_factor</span>(model, P, T; z<span class="op">=</span>[<span class="fl">1.0</span>])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    ρ <span class="op">=</span> <span class="fu">mass_density</span>(model, P, T, z)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> <span class="fu">speed_of_sound</span>(model, P, T, z)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> ρ<span class="op">*</span>c<span class="op">^</span><span class="fl">2</span><span class="op">/</span>P</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using effective isentropic expansion factors from the VTPR equation of state, the theoretical mass flux is 57811 kg m^-2 s^-1 ( 59321 kg m^-2 s^-1 from GERG-2008 ). This is quite a bit larger than the ideal case, indicating that the ideal gas law leads to a significantly over-sized PRV, 51.0% larger.</p>
<div id="fig-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figure1.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: The isentropic expansion factor for ethane at 400K, calculated for a range of stagnation pressures.
</figcaption>
</figure>
</div>
<p>The isentropic expansion factor method works best when <span class="math inline">\(n\)</span> is approximately constant over the isentropic path. As the above figure shows, this breaks down in ethane for pressures greater than ~100 bar. It also shows that the different equations of state start to diverge greatly further into the supercritical regime.</p>
</section>
<section id="solving-the-choked-flow-energy-balance" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="solving-the-choked-flow-energy-balance">Solving the Choked Flow Energy Balance</h2>
<p>Another approach, and one I have seen more often in older references, is to perform an energy balance over the isentropic path and, assuming the flow is choked, solve for sonic velocity in the nozzle.<span class="citation" data-cites="crowl-2008 gmehling-2012"><a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a></span> Consider an energy balance starting at the stagnation point, (1), and following an isentropic path to immediately after the throat of the nozzle (t).</p>
<div class="no-row-height column-margin column-container"><div id="fn12"><p><sup>12</sup>&nbsp;<a href="#ref-crowl-2008" role="doc-biblioref">Crowl et al., <span>“Process Safety.”</span> 23–55</a>; <a href="#ref-gmehling-2012" role="doc-biblioref">Gmehling et al., <em>Chemical Thermodynamics for Process Simulation</em>, 603</a>.</p></div></div><p><span class="math display">\[ h_1 = h_t + \frac{1}{2} c_t^2 \]</span></p>
<p>Where <span class="math inline">\(c_t\)</span> is the speed of sound at the nozzle, a function of <span class="math inline">\(P_t\)</span> and <span class="math inline">\(T_t\)</span>. The procedure is then to solve the system of equations given by the energy balance and the entropy balance, <span class="math inline">\(s_1 = s_t\)</span>, for <span class="math inline">\(P_t\)</span> and <span class="math inline">\(T_t\)</span>, then the theoretical mass flux is given by</p>
<p><span class="math display">\[ G_t = \rho_t c_t \]</span></p>
<p>There are a few ways this could be done, a straight-forward way is to divide the problem into two: 1. Define the isentropic path, i.e.&nbsp;find the isentropic temperature for a given pressure <em>P</em> 2. Use the energy balance to solve for the pressure, following the isentropic path.</p>
<p>A more direct way is to solve for <span class="math inline">\(P_t\)</span> and <span class="math inline">\(T_t\)</span> simultaneously. This is what I do next, using <a href="https://docs.sciml.ai/NonlinearSolve/stable/">NonlinearSolve.jl</a></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clapeyron does not expose this by default</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">molecular_weight</span>(model,z) <span class="op">=</span> Clapeyron.<span class="fu">molecular_weight</span>(model,z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">nozzle_balance</span>(y, prms)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    P, T <span class="op">=</span> y</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># stagnation point</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    s₁ <span class="op">=</span> prms.entropy</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    h₁ <span class="op">=</span> prms.enthalpy</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># at throat conditions</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    s₂ <span class="op">=</span> <span class="fu">entropy</span>(prms.model, P, T, prms.z)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    h₂ <span class="op">=</span> <span class="fu">enthalpy</span>(prms.model, P, T, prms.z)<span class="op">/</span>prms.Mw</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    c² <span class="op">=</span> <span class="fu">speed_of_sound</span>(prms.model, P, T, prms.z)<span class="op">^</span><span class="fl">2</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [ s₁ <span class="op">-</span> s₂</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>             h₁ <span class="op">-</span> h₂ <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span>c² ]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mass_flux_choked_energy_balance</span>(model, P, T; z<span class="op">=</span>[<span class="fl">1.0</span>])</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate the entropy and specific enthalpy at </span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initial conditions</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    Mw <span class="op">=</span> <span class="fu">molecular_weight</span>(model, z)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    s₁ <span class="op">=</span> <span class="fu">entropy</span>(model, P, T)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    h₁ <span class="op">=</span> <span class="fu">enthalpy</span>(model, P, T)<span class="op">/</span>Mw</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># solve the choked flow energy balance for</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># an isentropic nozzle</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> (model<span class="op">=</span>model, entropy<span class="op">=</span>s₁, enthalpy<span class="op">=</span>h₁, z<span class="op">=</span>z, Mw<span class="op">=</span>Mw)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    y₀ <span class="op">=</span> [P; T]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">=</span> <span class="fu">NonlinearProblem</span>(nozzle_balance, y₀, params)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    sol <span class="op">=</span> <span class="fu">solve</span>(prob, <span class="fu">NewtonRaphson</span>())</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    Pₜ, Tₜ <span class="op">=</span> sol.u</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># velocity is the sonic velocity at nozzle conditions</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    ρₜ <span class="op">=</span> <span class="fu">mass_density</span>(model, Pₜ, Tₜ, z)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    cₜ <span class="op">=</span> <span class="fu">speed_of_sound</span>(model, Pₜ, Tₜ, z)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ρₜ<span class="op">*</span>cₜ</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mass_flux_choked_energy_balance</span>(model, P<span class="op">::</span><span class="dt">Quantity</span>, T<span class="op">::</span><span class="dt">Quantity</span>; z<span class="op">=</span>[<span class="fl">1.0</span>])</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    P <span class="op">=</span> <span class="fu">ustrip</span>(u<span class="st">"Pa"</span>, P)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="fu">ustrip</span>(u<span class="st">"K"</span>, T)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">mass_flux_choked_energy_balance</span>(model, P, T; z<span class="op">=</span>z)<span class="op">*</span><span class="fl">1</span>u<span class="st">"kg*m^-2*s^-1"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Solving the choked flow energy balance, using VTPR equation of state, the theoretical mass flux is 54629 kg m^-2 s^-1 ( 54353 kg m^-2 s^-1 from GERG-2008 ). This is also quite a bit larger than the ideal case, 42.0% larger. Though the values for the two equations of state are closer, indicating that this method is less sensitive to model choice.</p>
<div id="fig-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figure2.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The isentropic paths for the ideal gas, effective isentropic factor, and true isentropic path methods.
</figcaption>
</figure>
</div>
<p>In this case the ideal gas method and the isentropic expansion factor method bracket the more exact method of solving the energy balance directly.</p>
<p>As it is written, this method would need to be modified to allow for non-choked flow. This is done by eliminating the assumption <span class="math inline">\(u_t = c_t\)</span> and instead finding the conditions which maximize <span class="math inline">\(G_t\)</span> (subject to the constraints of the entropy balance and the enthalpy balance). This will arrive at the same solution, in the case of choked flow, but with a little more effort.</p>
</section>
<section id="direct-integration" class="level2">
<h2 class="anchored" data-anchor-id="direct-integration">Direct Integration</h2>
<p>Direct integration is the method most commonly recommended today, as it is entirely general. It can be used to solve all flow conditions from liquids to gases as well as two-phase mixtures. As a reminder, this method constitutes finding the <span class="math inline">\(P_t\)</span> and <span class="math inline">\(T_t\)</span> that maximize the mass flux given by</p>
<p><span class="math display">\[ G_t = \rho_t \sqrt{2 \int_{P_t}^{P_1} v dP} \]</span></p>
<p>First introduce the change of variables <span class="math inline">\(\Delta P = P_1 - P\)</span> such that the integration is from <span class="math inline">\(0\)</span> to <span class="math inline">\(P_1 - P_2\)</span>.</p>
<p><span class="math display">\[ \int_{P_2}^{P_1} v dP = - \int_{0}^{\Delta P} v\left( P_1 - \Delta P \right)_{s = s_1} d\left(\Delta P \right) \]</span></p>
<p>This allows us to write the corresponding differential equation</p>
<p><span class="math display">\[ { {d} \over {d \left(\Delta P \right)} } I = v\left(P₁ - ΔP\right) \]</span></p>
<p>subject to the constraint</p>
<p><span class="math display">\[ s(P_1 - \Delta P, T) = s(P_1, T_1) \]</span></p>
<p>Which can be implemented as a differential algebraic equation using <a href="https://docs.sciml.ai/DiffEqDocs/stable/">DifferentialEquations.jl</a></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DifferentialEquations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rhs</span>(u, params, ΔP)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    ∫vdP, T <span class="op">=</span> u</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    model, P₁, s₁, z, Mw <span class="op">=</span> params</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    P <span class="op">=</span> P₁ <span class="op">-</span> ΔP</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [ <span class="fu">volume</span>(model, P, T, z)<span class="op">/</span>Mw</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>             s₁ <span class="op">-</span> <span class="fu">entropy</span>(model, P, T) ]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But we want to stop the integration when <span class="math inline">\({ {\partial G} \over {\partial \left( \Delta P \right) } } = 0\)</span> or, equivalently, when the velocity is sonic. We can show that these are the same by finding the stationary points of <span class="math inline">\(G^2\)</span></p>
<p><span class="math display">\[ { {\partial G^2} \over {\partial \left( \Delta P \right) } } = { {\partial } \over {\partial \left( \Delta P \right) } } \left( 2 \rho_t^2 \int_0^{\Delta P_t} v d \left( \Delta P \right) \right) = 0 \]</span></p>
<p>by applying the chain rule and cancelling <span class="math inline">\(\rho\)</span> we get</p>
<p><span class="math display">\[ 2 \left( {\partial \rho} \over { \partial P } \right)_S \int_0^{\Delta P_t} v d \left( \Delta P \right) - 1 = 0 \]</span></p>
<p>recalling the definition of the speed of sound (<a href="#the-isentropic-expansion-factor">above</a>)</p>
<p><span class="math display">\[ \left( {\partial \rho} \over { \partial P } \right)_S = \frac{1}{c^2} \]</span></p>
<p>we have</p>
<p><span class="math display">\[ 2 \int_0^{\Delta P_t} v d \left( \Delta P \right) - c^2 = 0 \]</span></p>
<p>which is simply restating <span class="math inline">\(u_t = c_t\)</span>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">∂G²_callback</span>(u, ΔP, integrator)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    ∫vdP, Tₜ <span class="op">=</span> u</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    model, P₁, s₁, z, Mw <span class="op">=</span> integrator.p</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    Pₜ <span class="op">=</span> P₁ <span class="op">-</span> ΔP</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> <span class="fu">speed_of_sound</span>(model, Pₜ, Tₜ, z)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">2</span>∫vdP <span class="op">-</span> c<span class="op">^</span><span class="fl">2</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mass_flux_direct_integration</span>(model, P₁, T₁, P₂; </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                                      z<span class="op">=</span>[<span class="fl">1.0</span>], solver<span class="op">=</span><span class="fu">Rodas5P</span>())</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    s₁ <span class="op">=</span> <span class="fu">entropy</span>(model, P₁, T₁, z)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    Mw <span class="op">=</span> <span class="fu">molecular_weight</span>(model, z)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># defining the ODEFunction</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> [ <span class="fl">1</span> <span class="fl">0</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>          <span class="fl">0</span> <span class="fl">0</span> ]</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> <span class="fu">ODEFunction</span>(rhs, mass_matrix <span class="op">=</span> M)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># defining the ODEProblem</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    u0 <span class="op">=</span> [<span class="fl">0.0</span>; T₁]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> (model, P₁, s₁, z, Mw)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    ΔP_span <span class="op">=</span> (<span class="fl">0.0</span>, P₁ <span class="op">-</span> P₂)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    prob <span class="op">=</span> <span class="fu">ODEProblem</span>(f, u0, ΔP_span, params)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    cb <span class="op">=</span> <span class="fu">ContinuousCallback</span>(∂G²_callback, terminate!)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># solving the DAE</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    sol <span class="op">=</span> <span class="fu">solve</span>(prob, solver, callback<span class="op">=</span>cb)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># unpacking the solution</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    ΔPₜ <span class="op">=</span> sol.t[<span class="kw">end</span>]</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    ∫vdP, Tₜ <span class="op">=</span> sol.u[<span class="kw">end</span>]</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    ρₜ <span class="op">=</span> <span class="fu">mass_density</span>(model, P₁<span class="op">-</span>ΔPₜ, Tₜ, z)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> <span class="fu">ρₜ*√</span>(<span class="fl">2</span><span class="op">*</span>∫vdP)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mass_flux_direct_integration</span>(model, P₁<span class="op">::</span><span class="dt">Quantity</span>, T₁<span class="op">::</span><span class="dt">Quantity</span>,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                          P₂<span class="op">::</span><span class="dt">Quantity</span>; z<span class="op">=</span>[<span class="fl">1.0</span>])</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    P_1 <span class="op">=</span> <span class="fu">ustrip</span>(u<span class="st">"Pa"</span>, P₁)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    P_2 <span class="op">=</span> <span class="fu">ustrip</span>(u<span class="st">"Pa"</span>, P₂)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    T_1 <span class="op">=</span> <span class="fu">ustrip</span>(u<span class="st">"K"</span>, T₁)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">mass_flux_direct_integration</span>(model, P_1, T_1, P_2; z<span class="op">=</span>z)<span class="op">*</span><span class="fl">1</span>u<span class="st">"kg*m^-2*s^-1"</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Direct integration of the VTPR equation of state gives a theoretical mass flux of 54629 kg m^-2 s^-1 ( 54353 kg m^-2 s^-1 from GERG-2008 ). Which is exactly the same as from solving the choked flow energy balance, as expected.</p>
<div id="fig-4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figure3.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The mass flux as a function of nozzle pressure drop, showing the intermediate steps until a maximum was found.
</figcaption>
</figure>
</div>
<p>Writing this as a differential algebraic equation was largely necessary because <code>Clapeyron.jl</code> does not expose any routines to calculate the volume as a function of pressure and entropy. Some libraries like <code>CoolProps</code> do, in which case the code could be simplified to be a one dimensional ode.</p>
<p>This method could be extended to include liquid and two-phase flows however, as it is currently implemented, it only handles gases. Unlike the energy balance method, though, the flow does not have to be choked. If the flow is not choked, the maximum will occur once the nozzle pressure reaches <span class="math inline">\(P_2\)</span>. This result will simply pop out without any extra effort.</p>
</section>
<section id="comparing-the-results" class="level2">
<h2 class="anchored" data-anchor-id="comparing-the-results">Comparing the Results</h2>
<p>For the sake of completeness, there are two other methods that should be looked at, which are really special cases: 1. the ideal gas case, but using the real compressibility, <span class="math inline">\(Z\)</span>, at stagnation conditions, this is the API 520 standard approach for gases 2. using the isentropic expansion factor, <em>n</em> factor, method but calculating <em>n</em> at the average of the stagnation and nozzle conditions</p>
<p>These two approaches do better than the basic methods I presented, but I don’t think they add enough value on their own. Given a model of the gas which can generate the compressibility, using either the energy balance method or the direct integration method produces superior results than correcting the ideal gas case. Once a viable equation of state is in hand, the simplifications are not saving any <em>actual engineer doing their job</em> time, they are saving fractions of a second of compute time.</p>
<p>I think the choice between the first law energy balance and the direct integration technique is more a matter of taste, at least in the case of choked flow. The direct integration method is in the relevant engineering codes/standards, and that is a strong justification for using it.</p>
<div id="fig-5" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figure4.svg" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: A comparison of calculated theoretical mass flux for the six methods. The results from the first law energy balance and direct integration are identical.
</figcaption>
</figure>
</div>
<p>In this case the choice of equation of state did not matter strongly, just for fun I have included a few other common cubic equations of state, they all perform reasonably. However this example is for a single compound that is not strongly associating, it is the type of example where cubic equations of state should work well. The choice of equation of state will be far more important with mixtures and strongly associating substances.</p>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>I have long been an advocate for engineering to move out of using spreadsheets for everything and to use scripting languages and notebooks like <a href="https://jupyter.org/">Jupyter</a> and <a href="https://plutojl.org/">Pluto</a> far more. There are large classes of problems that are easy to solve with code and hard to solve with a spreadsheet. I think almost any calculation using equations of state fit into that category. We end up beholden to commercial software suppliers for calculations that, in my view, engineers should be doing themselves.</p>
<p>Presumably you could do the calculations I laid out above in Excel, at enormous effort, and making liberal use of the solver. Julia, however, has a robust ecosystem for doing all the complicated math, it only needed to be connected up. What remains, for the engineer, is assessing the physical system and picking the appropriate methods and thermodynamic models.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-API-2020" class="csl-entry" role="listitem">
API. <em>Standard 520, Sizing, Selection, and Installation of Pressure-Relieving Devices, Part i - Sizing and Selection, 10th Ed</em>. Washington, DC: American Petroleum Institute, 2020.
</div>
<div id="ref-CCPS-2017" class="csl-entry" role="listitem">
Chemical Process Safety, Center for. <em>Guidelines for Pressure Relief and Effluent Handling Systems</em>. Hoboken, NJ: John Wiley &amp; Sons, 2017.
</div>
<div id="ref-crowl-2008" class="csl-entry" role="listitem">
Crowl, Daniel A., Lawrence G. Britton, Walter L. Frank, Stanley Grossel, Dennis Hendershot, W. G. High, Robert W. Johnson, et al. <span>“Process Safety.”</span> In <em>Perry’s Chemical Engineers’ Handbook</em>, edited by Don W. Green. New York: McGraw Hill, 2008.
</div>
<div id="ref-gmehling-2012" class="csl-entry" role="listitem">
Gmehling, Jürgen, Bärbel Kolbe, Michael Kleiber, and Jürgen Rary. <em>Chemical Thermodynamics for Process Simulation</em>. Weinheim, DE: Wiley-VCH Verlag &amp; Co., 2012.
</div>
<div id="ref-perrys-2008" class="csl-entry" role="listitem">
Green, Don W., ed. <em>Perry’s Chemical Engineers’ Handbook</em>. New York: McGraw Hill, 2008.
</div>
<div id="ref-tilton-2008" class="csl-entry" role="listitem">
Tilton, James N. <span>“Fluid and Particle Dynamics.”</span> In <em>Perry’s Chemical Engineers’ Handbook</em>, edited by Don W. Green. New York: McGraw Hill, 2008.
</div>
</div>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/aefarrell\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="aefarrell/aefarrell.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>